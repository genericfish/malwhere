<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malwhere: Analysis</title>

    <link rel="stylesheet" href="/static/styles/main.css">
    <link rel="stylesheet" href="/static/styles/analysis.css">
</head>
<body>
    <nav>
        <div id="logo"><a href="/">malwhere</a></div>
        <div id="program">analyze: {{ submission_id }}</div>
    </nav>
    <div class="container">
        <ul id="function-tree">
        {% for fname, data in functions.items() %}
            <li><span data-func="{{ data['entry'] }}">{{ data["simpleName"] }}</span></li>
        {% endfor %}
        </ul>
        <div id="function-code">
            {% set indent = namespace(value=0) %}
            {%- for fname, data in functions.items() -%}
            <div id="{{ data['entry'] }}" class="function" style="display: none;">
                <div class="info">
                    <span class="name">Function: {{ data["simpleName"] }}</span>
                    <span class="address">(entry: {{ data["entry"] }})</span>
                </div>
                {%- for token in data["tokens"] -%}
                    {%- if token["type"] == "SyntaxToken" and token["value"] == "{" -%}
                        {% set indent.value = indent.value + 1 %}
                    {%- endif -%}


                    {%- if loop.index + 1 < data["tokens"]|length -%} 
                        {% set next = data["tokens"][loop.index + 1] %}
                        {%- if next["type"] == "SyntaxToken" and next["value"] == "}" -%}
                            {% set indent.value = indent.value - 1 %}
                        {%- endif -%}
                    {%- endif -%}
                    {%- if token["type"] == "Break" -%}
                        <br>
                        <span>{{ "&nbsp;"|safe*4*indent.value }}</span>
                    {%- else -%}
                        <span class="token {{ token['type'] }} {% if 'constant' in token %}constant{% endif %}"
                            {%- if 'min_address' in token -%}
                            data-min-address="{{ token['min_address'] }}"
                            {%- endif -%}
                            {%- if 'max_address' in token -%}
                            data-max-address="{{ token['max_address'] }}"
                            {%- endif -%}
                            {%- if 'var_address' in token -%}
                            data-var-address="{{ token['var_address'] }}"
                            {%- endif -%}
                            {%- if 'constant' in token -%}
                            data-constant="1"
                            {%- endif -%}
                        >{{ token["value"] }}</span>
                    {%- endif -%}
                {%- endfor -%}
            </div>
            {%- endfor -%}
        </div>
    </div>

    <script>
        const functions = document.getElementsByClassName("function")
        const tokens = document.getElementsByClassName("token")

        const popup = document.createElement("div")
        popup.classList.add("popup")

        document.body.appendChild(popup)

        for (let token of tokens) {
            token.addEventListener("mouseover", event => {
                text = ""

                if (token.hasAttribute("data-min-address"))
                    text += `min-addr: 0x${token.getAttribute("data-min-address")}`

                if (token.hasAttribute("data-max-address"))
                    text += `\nmax-addr: 0x${token.getAttribute("data-max-address")}`

                if (token.hasAttribute("data-var-address"))
                    text += `\nvar-addr: 0x${token.getAttribute("data-var-address")}`

                if (token.hasAttribute("data-constant"))
                    text += `\nconstant`

                if (text.length == 0)
                    return

                popup.style.display = null
                popup.innerText = text

                bbox = token.getBoundingClientRect()
                pbbox = popup.getBoundingClientRect()
                popup.style.top = `${bbox.y - pbbox.height}px`
                popup.style.left = `${Math.max(1, bbox.x - pbbox.width / 2)}px`
            })

            token.addEventListener("mouseleave", _ => popup.style.display = "none")
        }

        const functionTree = document.getElementById("function-tree")
        let activeFunction = null
        for (let func of functionTree.children) {
            const span = func.children[0]

            func.addEventListener("click", _ => {
                if (activeFunction)
                    activeFunction.style.display = "none"

                const id = span.getAttribute("data-func")
                console.log(id)

                activeFunction = document.getElementById(id)
                activeFunction.style.display = null
            })
        }
    </script>
</body>
</html>
